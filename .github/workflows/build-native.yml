name: Build NativeAOT Version

on:
    release:
        types: [published, prereleased]
    workflow_dispatch:
        inputs:
            tag_name:
                description: "Tag to attach release files (e.g. v0.3.0)"
                required: false

permissions:
    contents: write

env:
    DOTNET_VERSION: 10.0.x
    NATIVE_PROJ: Banned.AniParser.Native/Banned.AniParser.Native.csproj

jobs:
    build:
        name: build (${{ matrix.rid }})
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: windows-latest
                      rid: win-x64
                      shell: pwsh
                    - os: ubuntu-latest
                      rid: linux-x64
                      shell: bash
                    - os: ubuntu-latest
                      rid: linux-arm64
                      shell: bash
                    - os: macos-15-intel
                      rid: osx-x64
                      shell: bash
                    - os: macos-latest
                      rid: osx-arm64
                      shell: bash

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Install toolchain (Ubuntu)
              if: startsWith(matrix.os, 'ubuntu')
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang lld zlib1g-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu
                  # If building linux-arm64 on an x86 runner, make the aarch64 objcopy the default
                  if [ "${{ matrix.rid }}" = "linux-arm64" ]; then
                    echo "Linking aarch64 objcopy to /usr/bin/objcopy"
                    sudo ln -sf "$(which aarch64-linux-gnu-objcopy)" /usr/bin/objcopy
                  fi

            - name: Diagnostics (pre-build, Unix)
              if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'macos')
              shell: bash
              run: |
                  set -euo pipefail
                  echo "=== DIAGNOSTICS: toolchain paths & versions ==="
                  echo "which objcopy: $(which objcopy 2>/dev/null || echo 'not found')"
                  objcopy --version 2>/dev/null || true
                  echo "which aarch64-linux-gnu-objcopy: $(which aarch64-linux-gnu-objcopy 2>/dev/null || echo 'not found')"
                  aarch64-linux-gnu-objcopy --version 2>/dev/null || true
                  echo "clang:"
                  clang --version 2>/dev/null || true
                  echo "ld:"
                  ld --version 2>/dev/null || true
                  echo "lld:"
                  lld --version 2>/dev/null || true || echo "lld not available"
                  echo "ls /usr/bin/objcopy:"
                  ls -l /usr/bin/objcopy || true

            - name: Install toolchain (macOS)
              if: startsWith(matrix.os, 'macos')
              run: |
                  xcode-select --install || true

            - name: Restore
              run: dotnet restore

            - name: Publish NativeAOT (Unix)
              if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'macos')
              shell: bash
              env:
                  IlcLDFLAGS: -fuse-ld=lld
              run: |
                  set -euo pipefail
                  if [ "${{ matrix.rid }}" = "linux-arm64" ]; then
                    echo "Using lld for linux-arm64 linking"
                    dotnet publish "${{ env.NATIVE_PROJ }}" -c Release -r ${{ matrix.rid }} -p:IlcLDFLAGS="-fuse-ld=lld"
                  else
                    dotnet publish "${{ env.NATIVE_PROJ }}" -c Release -r ${{ matrix.rid }}
                  fi

            - name: Publish NativeAOT (Windows)
              if: startsWith(matrix.os, 'windows')
              shell: pwsh
              run: |
                  $rid = "${{ matrix.rid }}"
                  dotnet publish "${{ env.NATIVE_PROJ }}" -c Release -r $rid

            - name: Rename output (Windows)
              if: startsWith(matrix.os, 'windows')
              shell: pwsh
              run: |
                  $rid = "${{ matrix.rid }}"
                  $projDir = Split-Path "${{ env.NATIVE_PROJ }}"
                  $publishDir = Join-Path $projDir "bin/Release/net10.0/$rid/publish"
                  $nativeDir  = Join-Path $projDir "bin/Release/net10.0/$rid/native"

                  $file = Get-ChildItem -Path $publishDir -Filter *.dll -File -ErrorAction SilentlyContinue | Select-Object -First 1
                  if (-not $file) { $file = Get-ChildItem -Path $nativeDir -Filter *.dll -File -ErrorAction SilentlyContinue | Select-Object -First 1 }
                  if (-not $file) { throw "No DLL found in $publishDir or $nativeDir" }

                  switch ($rid) {
                    "win-x64"   { $out = "Banned.AniParser.Native-windows-amd64.dll" }
                    default     { throw "Unexpected rid: $rid" }
                  }

                  New-Item -ItemType Directory -Path dist -Force | Out-Null
                  Copy-Item $file.FullName (Join-Path dist $out) -Force
                  "ASSET=dist/$out" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding ascii

            - name: Rename output (*nix)
              if: startsWith(matrix.os, 'ubuntu') || startsWith(matrix.os, 'macos')
              shell: bash
              run: |
                  set -e
                  PUBLISH_DIR="$(dirname "${{ env.NATIVE_PROJ }}")/bin/Release/net10.0/${{ matrix.rid }}/publish"
                  mkdir -p dist
                  case "${{ matrix.rid }}" in
                    linux-x64)   OUT="Banned.AniParser.Native-linux-amd64.so" ;;
                    linux-arm64) OUT="Banned.AniParser.Native-linux-arm64.so" ;;
                    osx-x64)     OUT="Banned.AniParser.Native-macos-amd64.dylib" ;;
                    osx-arm64)   OUT="Banned.AniParser.Native-macos-arm64.dylib" ;;
                  esac

                  FILE=$(find "$PUBLISH_DIR" -maxdepth 1 -type f \( -name "*.so" -o -name "*.dylib" \) | head -n1)
                  if [ -z "$FILE" ]; then echo "No native lib in $PUBLISH_DIR"; exit 1; fi

                  cp "$FILE" "dist/$OUT"
                  echo "ASSET=dist/$OUT" >> $GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.rid }}
                  path: ${{ env.ASSET }}

    release:
        name: attach to release
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Resolve tag
              id: tag
              shell: bash
              run: |
                  if [ "${{ github.event_name }}" = "release" ]; then
                    echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref_type }}" = "tag" ]; then
                    echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                  else
                    echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
                  fi
                  echo "Using tag: $(cat $GITHUB_OUTPUT)"

            - name: Publish to GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag.outputs.TAG }}
                  files: artifacts/**/Banned.AniParser.Native-*
                  overwrite_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
